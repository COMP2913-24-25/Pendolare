<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { height: 400px; overflow-y: scroll; background: #f5f5f5; padding: 10px; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button, input, select { margin: 5px 0; padding: 8px; }
        select, input[type="text"] { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Debugger</h1>
    
    <div>
        <label for="protocol">Protocol:</label>
        <select id="protocol">
            <option value="wss://">WSS (Secure)</option>
            <option value="ws://">WS (Insecure)</option>
        </select>
    </div>
    
    <div>
        <label for="host">Host:</label>
        <input type="text" id="host" value="kong-gateway.greensand-8499b34e.uksouth.azurecontainerapps.io">
    </div>
    
    <div>
        <label for="path">Path:</label>
        <input type="text" id="path" value="/message/ws">
    </div>
    
    <div>
        <label for="timeout">Connection Timeout (ms):</label>
        <input type="number" id="timeout" value="10000">
    </div>
    
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
    
    <h3>Connection Log</h3>
    <div id="log" class="log"></div>
    
    <script>
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const protocolSelect = document.getElementById('protocol');
        const hostInput = document.getElementById('host');
        const pathInput = document.getElementById('path');
        const timeoutInput = document.getElementById('timeout');
        const logDiv = document.getElementById('log');
        
        let socket = null;
        let connectionTimeout = null;
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        function testNetworkConnectivity(url, timeout) {
            log(`Testing network connectivity to ${url}...`);
            
            // Create an image element to test basic connectivity
            const img = new Image();
            img.onload = () => log(`Basic HTTP connectivity to host confirmed`, 'success');
            img.onerror = () => log(`Could not reach host via HTTP - this may be normal for WebSocket-only endpoints`, 'info');
            
            // Try to load a favicon or similar small resource
            const httpUrl = url.replace(/^wss?:\/\//i, 'https://') + '/favicon.ico';
            img.src = httpUrl;
            
            // Also try a fetch with detailed error reporting
            fetch(httpUrl.replace('/favicon.ico', ''))
                .then(response => {
                    log(`HTTP request successful: ${response.status} ${response.statusText}`, 'success');
                    return response.text();
                })
                .then(text => {
                    if (text.length < 100) log(`Response body: ${text}`);
                    else log(`Response received (${text.length} bytes)`);
                })
                .catch(err => {
                    log(`Fetch error: ${err.message}`, 'error');
                });
        }
        
        connectBtn.addEventListener('click', () => {
            const protocol = protocolSelect.value;
            const host = hostInput.value.trim();
            const path = pathInput.value.trim();
            const timeout = parseInt(timeoutInput.value);
            
            const url = `${protocol}${host}${path}`;
            log(`Attempting to connect to: ${url}`);
            
            // Test basic connectivity first
            testNetworkConnectivity(url, timeout);
            
            try {
                // Clear any existing timeout
                if (connectionTimeout) {
                    clearTimeout(connectionTimeout);
                }
                
                // Set a timeout to detect connection issues
                connectionTimeout = setTimeout(() => {
                    log(`Connection timed out after ${timeout}ms`, 'error');
                    if (socket && socket.readyState !== WebSocket.OPEN) {
                        log('WebSocket connection attempt failed - possible causes:', 'error');
                        log('1. Server is unreachable or not accepting WebSocket connections', 'error');
                        log('2. Network/firewall blocking WebSocket traffic', 'error');
                        log('3. Server not responding to WebSocket handshake properly', 'error');
                        socket.close();
                    }
                }, timeout);
                
                socket = new WebSocket(url);
                
                log(`WebSocket connection initiated. State: ${socket.readyState} (CONNECTING)`);
                
                socket.addEventListener('open', (event) => {
                    clearTimeout(connectionTimeout);
                    log(`WebSocket connection established!`, 'success');
                    log(`Socket state: ${socket.readyState} (OPEN)`);
                    
                    // Enable/disable buttons
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    
                    // Send a ping message
                    log(`Sending ping message...`);
                    socket.send(JSON.stringify({type: "ping", timestamp: new Date().toISOString()}));
                });
                
                socket.addEventListener('message', (event) => {
                    log(`Received message: ${event.data}`, 'success');
                    try {
                        const data = JSON.parse(event.data);
                        log(`Message type: ${data.type || 'unknown'}`);
                    } catch (e) {
                        // Not JSON, that's fine
                    }
                });
                
                socket.addEventListener('close', (event) => {
                    clearTimeout(connectionTimeout);
                    log(`Connection closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`, event.wasClean ? 'info' : 'error');
                    log(`Socket state: ${socket.readyState} (CLOSED)`);
                    
                    if (event.code === 1006) {
                        log('Code 1006 indicates abnormal closure - server likely terminated the connection', 'error');
                    }
                    
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                });
                
                socket.addEventListener('error', (event) => {
                    log(`WebSocket error occurred. See console for details.`, 'error');
                    console.error('WebSocket error:', event);
                });
                
            } catch (error) {
                clearTimeout(connectionTimeout);
                log(`Error initiating WebSocket: ${error.message}`, 'error');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                log(`Manually closing connection...`);
                socket.close(1000, "User initiated disconnect");
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        });
        
        // Initial log
        log(`WebSocket Debug Tool initialized. Click "Connect" to begin testing.`);
    </script>
</body>
</html>

_format_version: "2.1"
_transform: true

services:
  - name: message-service
    url: http://message-service:5006
    protocol: http
    routes:
      - name: message-ws-route
        protocols:
          - http
          - https
        paths:
          - /message/ws
        strip_path: true
        headers:
          Upgrade:
            - websocket
          Connection:
            - Upgrade
        methods:
          - GET
          - OPTIONS
      - name: message-websocket-direct
        protocols:
          - http
          - https
        paths:
          - /ws
        strip_path: false
        headers:
          Upgrade:
            - websocket
          Connection:
            - Upgrade
        methods:
          - GET
          - OPTIONS
      - name: message-history
        protocols:
          - http
          - https
        paths:
          - /message/history
        strip_path: false
        methods:
          - GET
      - name: message-open-conversation
        protocols:
          - http
          - https
        paths:
          - /message/open-conversation
        strip_path: false
        methods:
          - POST
    plugins:
      - name: request-transformer
        config:
          add:
            headers:
              - x-skip-auth:${request.querystring.skipAuth}
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: kid
          claims_to_verify:
            - exp
          anonymous: anonymous-consumer
          run_on_preflight: false
      - name: acl
        config:
          hide_groups_header: true
          allow:
            - anonymous
            - authenticated

  - name: identity-service
    url: http://identity-service:5001
    routes:
      - name: auth-route
        protocols:
          - http
          - https
        paths:
          - /api/auth
        strip_path: true
      - name: auth-request-otp
        protocols:
          - http
          - https
        paths:
          - /auth/request-otp
        strip_path: false
        methods:
          - POST
      - name: auth-verify-otp
        protocols:
          - http
          - https
        paths:
          - /auth/verify-otp
        strip_path: false
        methods:
          - POST
      - name: user-update
        protocols:
          - http
          - https
        paths:
          - /user/update
        strip_path: false
        methods:
          - POST
      - name: user-get
        protocols:
          - http
          - https
        paths:
          - /user/get
        strip_path: false
        methods:
          - GET

  - name: payment-service
    url: http://payment-service:5004
    routes:
      - name: payment-refund
        protocols:
          - http
          - https
        paths:
          - /payment/refund
        strip_path: false
        methods:
          - POST
      - name: payment-view
        protocols:
          - http
          - https
        paths:
          - /payment/view
        strip_path: false
        methods:
          - GET
      - name: payment-confirm
        protocols:
          - http
          - https
        paths:
          - /payment/confirm
        strip_path: false
        methods:
          - POST
      - name: payment-take
        protocols:
          - http
          - https
        paths:
          - /payment/take
        strip_path: false
        methods:
          - POST
      - name: payment-payout
        protocols:
          - http
          - https
        paths:
          - /payment/payout
        strip_path: false
        methods:
          - POST
  - name: api-gateway-status
    url: http://127.0.0.1:8001
    routes:
      - name: gateway-status
        protocols:
          - http
          - https
        paths:
          - /status
        strip_path: false
        methods:
          - GET

  - name: booking-service
    url: http://booking-service:5003
    routes:
      - name: booking-create
        protocols:
          - http
          - https
        paths:
          - /booking/create
        strip_path: false
        methods:
          - POST
      - name: booking-update
        protocols:
          - http
          - https
        paths:
          - /booking/update
        strip_path: false
        methods:
          - POST
      - name: booking-get
        protocols:
          - http
          - https
        paths:
          - /booking/get
        strip_path: false
        methods:
          - GET

  - name: journey-service
    url: http://journey-service:5002
    routes:
      - name: journey-create
        protocols:
          - http
          - https
        paths:
          - /journey/create
        strip_path: false
        methods:
          - POST
      - name: journey-view
        protocols:
          - http
          - https
        paths:
          - /journey/view
        strip_path: false
        methods:
          - GET

consumers:
  - username: anonymous-consumer
    acls:
      - group: anonymous

plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - Upgrade
        - Connection
      exposed_headers:
        - Authorization
      credentials: true
      max_age: 3600

  - name: rate-limiting
    config:
      minute: 60
      policy: local

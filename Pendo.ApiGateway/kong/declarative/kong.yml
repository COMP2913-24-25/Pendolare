# Kong Declaraive Config utilising a dbless pattern
# Derived from: https://docs.konghq.com/gateway/3.10.x/production/deployment-topologies/db-less-and-declarative-config

_format_version: "2.1"
_transform: true

services:
  - name: identity-service
    url: http://host.docker.internal:9003
    protocol: http
    routes:
      - name: identity-request-otp
        protocols: [http, https]
        paths: [/api/Identity/RequestOtp]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: identity-verify-otp
        protocols: [http, https]
        paths: [/api/Identity/VerifyOtp]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: identity-ping
        protocols: [http, https]
        paths: [/api/Identity/Ping]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: identity-update-user
        protocols: [http, https]
        paths: [/api/Identity/UpdateUser]
        strip_path: false
        preserve_host: false
        methods: [PATCH, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: identity-get-user
        protocols: [http, https]
        paths: [/api/Identity/GetUser]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]

  - name: payment-service
    url: http://host.docker.internal:9007
    protocol: http
    routes:
      - name: payment-health-check
        protocols: [http, https]
        paths: [/api/PaymentService/HealthCheck]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: payment-payment-sheet
        protocols: [http, https]
        paths: [/api/PaymentService/PaymentSheet]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-stripe-webhook
        protocols: [http, https]
        paths: [/api/PaymentService/StripeWebhook]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: payment-payment-methods
        protocols: [http, https]
        paths: [/api/PaymentService/PaymentMethods]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-pending-booking
        protocols: [http, https]
        paths: [/api/PaymentService/PendingBooking]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-completed-booking
        protocols: [http, https]
        paths: [/api/PaymentService/CompletedBooking]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-view-balance
        protocols: [http, https]
        paths: [/api/PaymentService/ViewBalance]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-refund-payment
        protocols: [http, https]
        paths: [/api/PaymentService/RefundPayment]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: payment-create-payout
        protocols: [http, https]
        paths: [/api/PaymentService/CreatePayout]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]

  - name: booking-service
    url: http://host.docker.internal:9004
    protocol: http
    routes:
      - name: booking-health-check
        protocols: [http, https]
        paths: [/api/Booking/HealthCheck]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
            config:
              anonymous: "anonymous-consumer"
          - name: acl
            config:
              hide_groups_header: true
              allow: [anonymous, authenticated, manager]
      - name: booking-get-bookings
        protocols: [http, https]
        paths: [/api/Booking/GetBookings]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-create-booking
        protocols: [http, https]
        paths: [/api/Booking/CreateBooking]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-add-amendment
        protocols: [http, https]
        paths: [/api/Booking/AddBookingAmmendment]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-approve-amendment
        protocols: [http, https]
        paths:
          - /api/Booking/ApproveBookingAmmendment
          - /api/Booking/ApproveBookingAmmendment/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-approve-booking
        protocols: [http, https]
        paths:
          - /api/Booking/ApproveBooking
          - /api/Booking/ApproveBooking/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-complete-booking
        protocols: [http, https]
        paths:
          - /api/Booking/CompleteBooking
          - /api/Booking/CompleteBooking/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: booking-confirm-atpikcup
        protocols: [http, https]
        paths:
          - /api/Booking/ConfirmAtPickup
          - /api/Booking/ConfirmAtPickup/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]

  - name: journey-service
    url: http://host.docker.internal:9008
    protocol: https
    routes:
      - name: journey-health-check
        protocols: [http, https]
        paths: [/api/Journey/HealthCheck]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: request-transformer
            config:
              remove:
                headers: ["Authorization"]
      - name: journey-create-journey
        protocols: [http, https]
        paths:
          - /api/Journey/CreateJourney
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: journey-view-journey
        protocols: [http, https]
        paths:
          - /api/Journey/ViewJourney
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: journey-lock-journey
        protocols: [http, https]
        paths:
          - /api/Journey/LockJourney
          - /api/Journey/LockJourney/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: journey-adjust-price
        protocols: [http, https]
        paths:
          - /api/Journey/AdjustPrice
          - /api/Journey/AdjustPrice/.*
        strip_path: false
        preserve_host: false
        methods: [PUT, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]

  - name: message-service
    url: http://host.docker.internal:9011
    protocol: http
    routes:
      - name: message-health-check
        protocols: [http, https]
        paths: [/api/Message/HealthCheck]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
            config:
              anonymous: "anonymous-consumer"
          - name: acl
            config:
              hide_groups_header: true
              allow: [anonymous, authenticated, manager]
      - name: message-user-conversation
        protocols: [http, https]
        paths:
          - /api/Message/UserConversation
          - /api/Message/UserConversation/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: message-support-conversation
        protocols: [http, https]
        paths:
          - /api/Message/SupportConversation
          - /api/Message/SupportConversation/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: message-create-conversation
        protocols: [http, https]
        paths: [/api/Message/CreateConversation]
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]

  - name: admin-service
    url: http://host.docker.internal:9005
    protocol: http
    routes:
      - name: admin-health-check
        protocols: [http, https]
        paths: [/api/Admin/HealthCheck]
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: admin-update-booking-fee
        protocols: [http, https]
        paths:
          - /api/Admin/UpdateBookingFee
          - /api/Admin/UpdateBookingFee/.*
        strip_path: false
        preserve_host: false
        methods: [PATCH, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: admin-get-booking-fee
        protocols: [http, https]
        paths:
          - /api/Admin/GetBookingFee
          - /api/Admin/GetBookingFee/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: admin-get-weekly-revenue
        protocols: [http, https]
        paths:
          - /api/Admin/GetWeeklyRevenue
          - /api/Admin/GetWeeklyRevenue/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [anonymous, authenticated, manager]
      - name: journey-analytics
        protocols: [http, https]
        paths:
          - /api/Admin/JourneyAnalytics
          - /api/Admin/JourneyAnalytics/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: journey-frequent-users
        protocols: [http, https]
        paths:
          - /api/Admin/FrequentUsers
          - /api/Admin/FrequentUsers/.*
        strip_path: false
        preserve_host: false
        methods: [GET, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: journey-discounts-create
        protocols: [http, https]
        paths:
          - /api/Admin/CreateDiscount
          - /api/Admin/CreateDiscount/.*
        strip_path: false
        preserve_host: false
        methods: [POST, OPTIONS]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]
      - name: journey-discounts-get
        protocols: [http, https]
        paths:
          - /api/Admin/Discounts
          - /api/Admin/Discounts/.*
        strip_path: false
        preserve_host: false
        methods: [GET]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [authenticated, manager]
      - name: journey-discounts-manage
        protocols: [http, https]
        paths:
          - /api/Admin/Discounts
          - /api/Admin/Discounts/.*
        strip_path: false
        preserve_host: false
        methods: [OPTIONS, DELETE]
        plugins:
          - name: jwt
          - name: acl
            config:
              hide_groups_header: true
              allow: [manager]

consumers:
  - username: anonymous-consumer
    acls:
      - group: anonymous
  - username: Pendo.IdentityService
    jwt_secrets:
      - key: Pendo.IdentityService
        # Randomly generated secret, not used in production
        secret: 7a3fd8625dbc03b9f08faa02eecbf90ab92c857a301bbfc1a8536bbdfcb5c1e7
        algorithm: HS256

plugins:
  - name: cors
    config:
      origins: ["*"]
      methods: [GET, POST, PUT, DELETE, OPTIONS]
      headers: [Accept, Authorization, Content-Type, Origin, X-Requested-With, Upgrade, Connection]
      exposed_headers: [Authorization]
      credentials: true
      max_age: 3600
      preflight_continue: false

  - name: response-transformer
    config:
      add:
        headers:
          - "Access-Control-Allow-Origin: *"
          - "Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS"
          - "Access-Control-Allow-Headers: Accept, Authorization, Content-Type, Origin, X-Requested-With"

  - name: rate-limiting
    config:
      second: 20
      minute: 1200
      hour: 72000
      policy: local
      hide_client_headers: false
      redis_timeout: 2000
      fault_tolerant: true

  - name: jwt
    config:
      uri_param_names: [jwt]
      cookie_names: []
      header_names: [Authorization]
      claims_to_verify: [exp]
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: false
      anonymous: "anonymous-consumer"

  - name: acl
    config:
      hide_groups_header: true
      allow: [anonymous, authenticated, manager]

  - name: jwt-custom-claims
    config:
      add_user_info_headers: true
      map_user_type_to_acl: true